CAN通信协议
一、总线的概念
总线是是一组用于计算机之间、各部件之间进行数据传输和命令传送的公用信号线；

二、总线的分类（按照功能和规范可以分为三大类型）
片总线（Chip Bus, C-Bus）又称为元件级总线，是把各种不同的芯片连接到一起构成特定功能模块（如CPU模块）的信息传输通路。

内总线（Internal Bus, I-Bus）又称为系统总线或板级总线，是微机系统中各模块之间的信息传输通路。例如CPU模块和存储区模块或I/O接口模块之间的传输通路。

外总线（External Bus, E-Bus）又称为通信总线，是微机系统之间或微机系统与其他系统（仪器、仪表、控制装置等）之间传输信息的通路，如RS-232，RS-485，现场总线CAN属于外总线；

image.png

好了，通过上述的知识点回顾，我们可以对今天的主角“CAN”总线有个大致定位。前边提到，CAN属于外总线，同时亦是现场总线，现场总线是当今自动化领域技术发展的热点之一，被誉为自动化领域的计算机局域网，汽车中使用的LIN总线、CAN总线等均属于现场总线。

三、CAN总线起源

1986 年 2 月，Robert Bosch 公司在 SAE（汽车工程协会）大会上介绍了一种新型的串行总线——CAN控制器局域网，那是 CAN 诞生的时刻。今天，在欧洲几乎每一辆新客车均装配有 CAN 局域网。同样，CAN也用于其他类型的交通工具，从火车到轮船或者用于工业控制。CAN 已经成为全球范围内最重要的总线之一 —— 甚至领导着串行总线。

CAN发源于汽车领域，我们看看汽车中CAN是怎样的存在，如下图：

image.png


四、CAN 基本知识 
1. 什么是 CAN ? 
CAN，全称为“Controller Area Network”，即控制器局域网，是国际上应用最广泛的现场总线之一。最初，CAN 被设计作为汽车环境中的微控制器通讯，在车载各电子控制装置 ECU 之间交换信息，形成汽车电子控制网络。比如：发动机管理系统、变速箱控制器、仪表装备、电子主干系统中，均嵌入 CAN 控制装置。一个由 CAN 总线构成的单一网络中，理论上可以挂接无数个节点。实际应用中，节点数目受网络硬件的电气特性所限制。例如，当使用 Philips P82C250 作为 CAN 收发器时，同一网络中允许挂接 110 个节点。CAN 可提供高达 1Mbit/s 的数据传输速率，这使实时控制变得非常容易。另外，硬件的错误检定特性也增强了 CAN 的抗电磁干扰能力。 

2. CAN 是怎样发展起来的？ 
CAN 最初出现在 80 年代末的汽车工业中，由德国 Bosch 公司最先提出。当时，由于消费者对于汽车功能的要求越来越多，而这些功能的实现大多是基于电子操作的，这就使得电子装置之间的通讯越来越复杂，同时意味着需要更多的连接信号线。提出 CAN 总线的最初动机就是为了解决现代汽车中庞大的电子控制装置之间的通讯，减少不断增加的信号线。于是，他们设计了一个单一的网络总线，所有的外围器件可以被挂接在该总线上。1993 年，CAN 已成为国际标准 ISO11898(高速应用)和 ISO11519（低速应用）。

CAN 是一种多主方式的串行通讯总线，基本设计规范要求有高的位速率，高抗电磁干扰性，而且能够检测出产生的任何错误。当信号传输距离达到 10Km 时，CAN 仍可提供高达 50Kbit/s 的数据传输速率。 由于 CAN 总线具有很高的实时性能，因此，CAN 已经在汽车工业、航空工业、工业控制、安全防护等领域中得到了广泛应用。 

3. CAN 是怎样工作的？ 
CAN 通讯协议主要描述设备之间的信息传递方式。CAN 层的定义与开放系统互连模型（OSI）一致。每一层与另一设备上相同的那一层通讯。实际的通讯发生在每一设备上相邻的两层，而设备只通过模型物理层的物理介质互连。CAN 的规范定义了模型的最下面两层：数据链路层和物理层。下表中展示了 OSI 开放式互连模型的各层。应用层协议可以由 CAN 用户定义成适合特别工业领域的任何方案。

image.png





五、CAN物理层
CAN 能够使用多种物理介质，例如双绞线、光纤等。最常用的就是双绞线。信号使用差分电压传送，两条信号线被称为“CAN_H”和“CAN_L”，静态时均是 2.5V 左右，此时状态表示为逻辑“1”，也可以叫做“隐性”。用 CAN_H 比 CAN_L 高表示逻辑“0”，称为“显形”，此时，通常电压值为：CAN_H = 3.5V 和 CAN_L = 1.5V 。

差分信号：振幅相等，相位相反的信号，与单端信号进行比较理解差分信号的有点，先说缺点：会增加一个线；

image.png


下图为CAN总线网络示意图，节点主要包括Host、控制器和收发器。Host常集成有CAN控制器，CAN控制器负责处理协议相关功能，以减轻Host的负担。CAN收发器将控制器连接到传输媒介。通常控制器和总线收发器通过光耦或磁耦隔离，这样即使总线上过压损坏收发器，控制器和Host设备也可以得到保护。

技术分享图片


1. CAN收发器
CAN总线分高速CAN和低速CAN，收发器也分为高速CAN收发器（1Mbps）和低速CAN收发器（125Kbps）。低速CAN也叫Fault Tolerance CAN(容错CAN)，指的是即使总线上一根线失效，总线依然可以通信。该模块的作用类似于串口中的MAX3232用作电平转换，CAN收发器的作用则是把逻辑信号转换为差分信号。

高速CAN

图片来自外部，暂时无法显示

低俗容错CAN

图片来自外部，暂时无法显示

技术分享图片

与I2C一样，CAN总线也是遵循的“线与”机制；显性”位可以覆 盖“隐性”位；只有所有节点都发 送“隐性”位， 总线才处于“隐性” 状态。这种“线与”机制使CAN总线呈现显性优先的特性。

图片来自外部，暂时无法显示

在发送数据时，CAN控制器把要发送的二进制编码通过CAN_Tx线发送到CAN收发器，然后由收发器把这个普通的逻辑电平信号转化成差分信号，通过差分线CAN_High和CAN_Low输出到CAN总线网络。接收数据过程，相反。采用差分信号，可以取得更好的电磁兼容效果。因此，CAN总线物理传输媒介只需要两根线。

高速CAN总线最高信号传输速率为1Mbps，支持最长距离40m。ISO11898-2要求在高速CAN总线两段安装端接电阻RL（端接电阻一般为120Ω，因为电缆的特性阻抗为120 Ω，为了模拟无限远的传输线。）以消除反射。低速CAN最高速度只有125Kbps，所以ISO11898-3没有端接要求。

image.png

技术分享图片

因为传输距离越大，信号时延也越大，为了保证消息的正确采样，总线上的信号速率相应也要下降。下图是推荐的信号速率与距离的关系。

技术分享图片




2. 什么是 CSMA/CD ? 
CSMA/CD 是“载波侦听多路访问/冲突检测”（Carrier Sense Multiple Access with Collision Detect）的缩写。 利用 CSMA 访问总线，可对总线上信号进行检测，只有当总线处于空闲状态时，才允许发送。利用这种方法，可以允许多个节点挂接到同一网络上。当检测到一个冲突位时，所有节点重新回到‘监听’总线状态，直到该冲突时间过后，才开始发送。在总线超载的情况下，这种技术可能会造成发送信号经过许多延迟。为了避免发送时延，可利用 CSMA/CD 方式访问总线。当总线上有两个节点同时进行发送时，必须通过“无损的逐位仲裁”方法来使有最高优先权的的报文优先发送。在 CAN 总线上发送的每一条报文都具有唯一的一个 11 位或 29 位数字的 ID。CAN 总线状态取决于二进制数‘0’而不是‘1’，所以 ID 号越小，则该报文拥有越高的优先权。因此一个为全‘0’标志符的报文具有总线上的最高级优先权。可用另外的方法来解释：在消息冲突的位置，第一个节点发送 0 而另外的节点发送 1，那么发送 0 的节点将取得总线的控制权，并且能够成功的发送出它的信息。

3. 什么是标准格式 CAN 和扩展格式 CAN?
标准 CAN 的标志符长度是 11 位，而扩展格式 CAN 的标志符长度可达 29 位。CAN 协议的 2.0A 版本规定 CAN 控制器必须有一个 11 位的标志符。同时，在 2.0B 版本中规定，CAN 控制器的标志符长度可以是 11 位或 29 位。遵循 CAN2.0B 协议的 CAN 控制器可以发送和接收 11 位标识符的标准格式报文或 29 位标识符的扩展格式报文。如果禁止 CAN2.0B,则 CAN 控制器只能发送和接收 11 位标识符的标准格式报文，而忽略扩展格式的报文结构，但不会出现错误。目前，Philips 公司主要推广的 CAN 独立控制器均支持 CAN2.0B 协议，即支持 29 位标识符的扩展格式报文结构。

4. 报文冲突的处理
如前所说 CAN 的一个基本特征是越低的报文编号 （号码） 其优先权越高——一个标识符如果全部是“0”的话，那么它具有最高优先权。因而，两个节点同时开始传送报文，第一个发送零而另一个发送 “1” 的话那么发送零的那个就能够先分配到 CPU 并完成报文发送。这种“非破坏性的逐位 ”仲裁与每一个节点都可以监控自己发送的能力联合使用。因而如果一个发送器 A 被另一个发送器 B 发送有更高优先权的报文支配 overrule 回读的报文和 A 企图发送的报文不一致 A 将暂停发送。一旦总线空闲，另一个请求就会马上发送。这是第一层的部分功能，它完全包含在 CAN 控制器里。因此它对 CAN 用户来说是透明的。

image.png

CAN 总线物理层通常是双绞线。当逻辑“1”被写进总线里，两条线的电平是 2.5V，并被定义为 “隐性 ”位 当逻辑“0”被写进总线里，一条线被上拉到为 5V（CAN 高）另一条线被下拉到地 CAN 低这叫做“显形”位，但是如果显形位和隐性位都被不同的节点同时写进总线里，总线显示“显形”位，所以显性位覆盖了隐性位，这些都是 CAN 网络冲突检测的基础。
